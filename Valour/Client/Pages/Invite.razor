@page "/I/{InviteCode}"

@inject NavigationManager NavManager
@inject ValourClient Client
@inject PlanetService PlanetService

<NebulaBackground ContentClasses="absolute-center">
    <div class="invite-card">
        <div class="col-md-12">
            <section class="text-center">

                @if (_inviteDataResult is null)
                {
                    <h2>Loading...</h2>
                }
                else if (!_inviteDataResult.Value.Success)
                {
                    <ResultLabel Result="@_inviteDataResult"/>
                    <button class="v-btn center mt-4" @onclick="OnClose">Back to Home</button>
                }
                else
                {
                    if (!Client.IsLoggedIn)
                    {
                        <div class="invite-planet-preview">
                            <DiscoveryPlanetCard PlanetInfo="@_inviteDataResult.Value.Data" HideActions="true"/>
                        </div>
                        <p class="invite-prompt">Create an account or log in to join this planet</p>
                        <div class="invite-actions">
                            <button class="v-btn mt-2 join-btn" @onclick="OnClickRegister">Join Valour</button>
                            <button class="v-btn mt-2 login-btn" @onclick="OnClickLogin">Log In</button>
                        </div>
                    }
                    else if (_alreadyJoined)
                    {
                        <DiscoveryPlanetCard PlanetInfo="@_inviteDataResult.Value.Data" HideActions="true"/>
                        <p class="already-joined-text">You're already a member of this planet!</p>
                        <button class="v-btn mt-2" @onclick="OnClose">Go to Home</button>
                    }
                    else
                    {
                        <DiscoveryPlanetCard PlanetInfo="@_inviteDataResult.Value.Data" OnJoin="OnJoinPlanet"/>
                    }
                }
            </section>
        </div>
    </div>
</NebulaBackground>

@code {

    [Parameter]
    public string InviteCode {get; set;}
    
    private TaskResult<PlanetListInfo>? _inviteDataResult;
    private bool _alreadyJoined = false;

    protected override async  Task OnInitializedAsync()
    {
        _inviteDataResult = await PlanetService.FetchInviteScreenDataAsync(InviteCode);
        
        // Already joined
        if (_inviteDataResult.HasValue &&
            _inviteDataResult.Value.Data is not null &&
            PlanetService.JoinedPlanets.Any(x => x.Id == _inviteDataResult.Value.Data.PlanetId))
        {
            _alreadyJoined = true;
        }

        StateHasChanged();

    }

    public async Task OnClose()
    {
        await PlanetService.FetchJoinedPlanetsAsync();
        NavManager.NavigateTo("/");
    }

    private void OnClickLogin()
    {
        NavManager.NavigateTo($"/?redirect=/i/{InviteCode}", true);
    }

    private void OnClickRegister()
    {
        NavManager.NavigateTo($"/register/i/{InviteCode}", true);
    }

    private async Task OnJoinPlanet(PlanetListInfo planetInfo)
    {
        var result = await ToastContainer.Instance.WaitToastWithResult(new ProgressToastData<TaskResult<PlanetMember>>()
        {
            ProgressTask = PlanetService.JoinPlanetAsync(planetInfo.PlanetId, InviteCode),
            Title = "Joining Planet",
            Message = "Landing rocket ship..."
        });

        if (result.Success)
        {
            _alreadyJoined = true;
            await PlanetService.FetchJoinedPlanetsAsync();
        }

        StateHasChanged();
    }
}
