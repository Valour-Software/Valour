@inherits WindowContentComponentBase
@implements IAsyncDisposable
@inject PlanetService PlanetService

<NebulaBackground>
    <div class="discovery-window inner-window @_mobileTag">
        @if (_isLoading)
        {
            <div class="discovery-loading">
                <div class="discovery-loading-spinner">
                    <i class="bi bi-arrow-clockwise"></i>
                </div>
                <p class="discovery-loading-text">Loading planets...</p>
            </div>
        }
        else if (UnjoinedPlanets.Count == 0)
        {
            <div class="discovery-empty">
                <div class="discovery-empty-icon">
                    <i class="bi bi-globe-americas"></i>
                </div>
                <h3>No Planets to Discover</h3>
                <p>You've already joined all available planets, or none are available right now.</p>
            </div>
        }
        else
        {
            <div class="planet-discovery-container">
                @if (PopularPlanets.Count > 0)
                {
                    <section class="discovery-section">
                        <div class="discovery-section-header">
                            <i class="bi bi-star-fill"></i>
                            <h2>Popular Planets</h2>
                        </div>
                        <div class="carousel-section">
                            <Carousel TItem="PlanetListInfo"
                                      @ref="_planetCarousel"
                                      Items="@PopularPlanets"
                                      GapPx="16"
                                      TransitionMs="300"
                                      MinItemWidth="300"
                                      MaxItemWidth="350"
                                      ItemPadding="12"
                                      FadeWidth="50">
                                <ItemTemplate>
                                    <DiscoveryPlanetCard PlanetInfo="@context" OnJoin="@HandleJoinAsync" />
                                </ItemTemplate>
                            </Carousel>
                        </div>
                    </section>
                }

                <section class="discovery-section">
                    <div class="discovery-section-header">
                        <i class="bi bi-compass"></i>
                        <h2>Explore All Planets</h2>
                    </div>

                    <div class="discovery-search-container">
                        <LargeSearch Placeholder="Search planets by name or description..."
                                     DebounceMs="300"
                                     OnSearchChanged="@OnSearchChanged"
                                     OnSearchCleared="@OnSearchCleared" />
                    </div>

                    <DiscoveryPlanetGrid @ref="PlanetGrid"
                                         IsLoading="@_isSearchLoading"
                                         OnJoin="@HandleJoinAsync"
                                         EmptyMessage="No planets found matching your search" />
                </section>
            </div>
        }
    </div>
</NebulaBackground>

@code {
    private string _mobileTag = "";
    private bool _isLoading = true;
    private List<PlanetListInfo> _all { get; set; } = new();
    private HashSet<long> _joinedIds { get; set; } = new();
    private List<PlanetListInfo> UnjoinedPlanets { get; set; } = new();
    private List<PlanetListInfo> PopularPlanets { get; set; } = new();
    private Carousel<PlanetListInfo> _planetCarousel;
    private string _searchTerm = string.Empty;
    private bool _carouselInitialized;
    private ModelQueryEngine<PlanetListInfo> _discoverablePlanetsQuery;
    private List<PlanetListInfo> _filteredPlanets = new();
    private bool _isSearchLoading = false;
    
    private DiscoveryPlanetGrid _planetGrid;
    private DiscoveryPlanetGrid PlanetGrid
    {
        get => _planetGrid;
        set
        {
            _planetGrid = value;
            _planetGrid?.SetPlanets(_filteredPlanets);
        }
    }
    
    private TaskResult _result = new();

    private const int InitialListLoad = 4;
    private int _loadedListCount = 0;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Initialize the query engine for discoverable planets
            _discoverablePlanetsQuery = PlanetService.CreateDiscoverablePlanetsQueryEngine();
            _discoverablePlanetsQuery.SetPageSize(50);
            
            await LoadDiscoveryPlanetsAsync();
            _loadedListCount = Math.Min(InitialListLoad, UnjoinedPlanets.Count);
        }
        catch (Exception ex)
        {
            _isLoading = false;
            _result.Success = false;
            _result.Message = ex.Message;
            Console.WriteLine("Error loading planets: " + ex);
            ReRender();
        }

        if (DeviceInfo.IsMobile)
        {
            _mobileTag = "mobile";
            ReRender();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && !_isLoading && !_carouselInitialized && _planetCarousel != null)
        {
            _carouselInitialized = true;
            await _planetCarousel.Reset();
        }
    }


   
    
    // ----------  helpers ----------

    private async Task LoadDiscoveryPlanetsAsync()
    {
        await PlanetService.FetchJoinedPlanetsAsync();
        _joinedIds = PlanetService.JoinedPlanets.Select(p => p.Id).ToHashSet();
        
        // Load initial page of discoverable planets
        await _discoverablePlanetsQuery.GetPageAsync(0, 50);
        _all = _discoverablePlanetsQuery.CurrentPage.ToList();
        
        UnjoinedPlanets = _all.Where(p => !_joinedIds.Contains(p.PlanetId)).ToList();

        // Popular planets have more than 20 members
        PopularPlanets = UnjoinedPlanets.Where(p => p.MemberCount > 20).ToList();
        _filteredPlanets = UnjoinedPlanets.ToList();
        
        _isLoading = false;
        _loadedListCount = Math.Min(_loadedListCount > 0 ? _loadedListCount : InitialListLoad, UnjoinedPlanets.Count);
        if (_planetCarousel != null)
            await _planetCarousel.Reset();
        
        _planetGrid?.SetPlanets(_filteredPlanets);
        
        ReRender();
    }



    
    private async Task HandleJoinAsync(PlanetListInfo planet)
    {
        await PlanetService.JoinPlanetAsync(planet.PlanetId);

        // Add to joined IDs
        _joinedIds.Add(planet.PlanetId);

        // Remove from all lists by planet ID to handle list copies
        UnjoinedPlanets.RemoveAll(p => p.PlanetId == planet.PlanetId);
        PopularPlanets.RemoveAll(p => p.PlanetId == planet.PlanetId);
        _filteredPlanets.RemoveAll(p => p.PlanetId == planet.PlanetId);

        // Update the grid
        _planetGrid?.SetPlanets(_filteredPlanets);

        // Reset carousel if it exists
        if (_planetCarousel != null)
            await _planetCarousel.Reset();

        ReRender();
    }

    private async Task OnSearchChanged(string searchTerm)
    {
        _searchTerm = searchTerm;
        await PerformSearch();
    }

    private async Task OnSearchCleared()
    {
        _isSearchLoading = true;
        StateHasChanged();

        try
        {
            _searchTerm = string.Empty;

            // Clear the search filter on the query engine
            if (_discoverablePlanetsQuery != null)
            {
                _discoverablePlanetsQuery.ResetPaging();
                _discoverablePlanetsQuery.SetFilter("search", null, apply: true);
            }

            // Reset to show all unjoined planets
            _filteredPlanets = UnjoinedPlanets.ToList();
            _planetGrid?.SetPlanets(_filteredPlanets);
        }
        finally
        {
            _isSearchLoading = false;
            StateHasChanged();
        }
    }

    private async Task PerformSearch()
    {
        if (_discoverablePlanetsQuery == null) return;
        
        _isSearchLoading = true;
        StateHasChanged();
        
        try
        {
            // Reset paging and set the search filter on the query engine
            _discoverablePlanetsQuery.ResetPaging();
            
            // Only apply search filter if search term is not null or empty
            if (!string.IsNullOrWhiteSpace(_searchTerm))
            {
                _discoverablePlanetsQuery.SetFilter("search", _searchTerm, apply: true);
            }
            else
            {
                _discoverablePlanetsQuery.SetFilter("search", null, apply: true);
            }
            
            // Get the first page of filtered results
            await _discoverablePlanetsQuery.GetPageAsync(0, 50);
            var filteredResults = _discoverablePlanetsQuery.CurrentPage.ToList();
            
            // Filter out joined planets
            _filteredPlanets = filteredResults.Where(p => !_joinedIds.Contains(p.PlanetId)).ToList();
            
            StateHasChanged();
            _planetGrid?.SetPlanets(_filteredPlanets);
        }
        finally
        {
            _isSearchLoading = false;
            StateHasChanged();
        }
    }

    public ValueTask DisposeAsync()
    {
        return ValueTask.CompletedTask;
    }

}
