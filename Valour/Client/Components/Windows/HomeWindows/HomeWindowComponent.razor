@inherits WindowContentComponentBase
@inject ValourClient Client
@inject PlanetService PlanetService
@inject FriendService FriendService
@inject ChannelService ChannelService
@inject UserService UserService
@inject ChannelStateService ChannelStateService
@inject UnreadService UnreadService
@inject NotificationService NotificationService

<div class="inner-window @_mobileTag">

    <div class="toolbar">
        <input @oninput="OnFilterInput" type="text" placeholder="Search..." class="search-input" />
        <button class="toggle-btn @(_viewMode == HomeViewMode.Cards ? "active" : "")" @onclick="() => SetViewMode(HomeViewMode.Cards)" title="Card view">
            <i class="bi bi-grid-3x3-gap-fill"></i>
        </button>
        <button class="toggle-btn @(_viewMode == HomeViewMode.Rows ? "active" : "")" @onclick="() => SetViewMode(HomeViewMode.Rows)" title="Row view">
            <i class="bi bi-list"></i>
        </button>
    </div>

    <TabContainerComponent Titles='new[] { "Planets", "DMs", "Friends" }'
                           IconOne="globe-americas"
                           IconTwo="chat-dots"
                           IconThree="people"
                           BadgeThree="@(_incomingFriendRequests > 0 ? _incomingFriendRequests : null)"
                           MaxHeight="none"
                           ContentStyle="padding: 0; display: flex; flex-direction: column; flex: 1; min-height: 0;">
        <TabOne>
            @* --- Joined Planets --- *@
            <div class="tab-scroll">
                @if (_viewMode == HomeViewMode.Cards)
                {
                    <div class="icon-container">
                        @foreach (Planet planet in _filteredPlanets)
                        {
                            <PlanetCardComponent @key='"joined-" + planet.Id' Planet='planet' WindowCtx='WindowCtx' HomeWindowComponent="this" />
                        }
                    </div>
                }
                else
                {
                    <div class="row-list">
                        @foreach (Planet planet in _filteredPlanets)
                        {
                            <PlanetRowComponent @key='"joined-row-" + planet.Id' Planet='planet' WindowCtx='WindowCtx' HomeWindowComponent="this" />
                        }
                    </div>
                }
            </div>

            @* --- Bottom actions --- *@
            <div class="bottom-actions">
                <button class="action-btn" @onclick="OnClickCreatePlanet">
                    <i class="bi bi-plus-circle"></i>
                    <span>Create a Planet</span>
                </button>
                <button class="action-btn" @onclick="OnClickDiscover">
                    <i class="bi bi-compass"></i>
                    <span>Discover Planets</span>
                </button>
            </div>
        </TabOne>

        <TabTwo>
            @* --- Direct Messages --- *@
            <div class="tab-scroll">
                <div class="row-list">
                    @if (_filteredDms.Count == 0)
                    {
                        <div class="empty-state">
                            <i class="bi bi-chat-dots"></i>
                            <span>@(string.IsNullOrWhiteSpace(_filterText) ? "No conversations yet" : "No results")</span>
                        </div>
                    }
                    else
                    {
                        @foreach (var dm in _filteredDms)
                        {
                            <DirectMessageRowComponent @key='"dm-" + dm.Channel.Id'
                                                       Channel="dm.Channel"
                                                       OtherUser="dm.OtherUser"
                                                       IsUnread="dm.IsUnread"
                                                       Notifications="dm.Notifications" />
                        }
                    }
                </div>
            </div>
        </TabTwo>

        <TabThree>
            @* --- Friends --- *@
            <div class="tab-scroll">
                @if (_viewMode == HomeViewMode.Cards)
                {
                    <div class="icon-container">
                        @foreach (var friend in _filteredFriends)
                        {
                            <FriendCardComponent @key='"friend-" + friend.Id' Friend="friend" WindowCtx="WindowCtx" HomeWindowComponent="this" />
                        }
                    </div>
                }
                else
                {
                    <div class="row-list">
                        @foreach (var friend in _filteredFriends)
                        {
                            <FriendRowComponent @key='"friend-row-" + friend.Id' Friend="friend" WindowCtx="WindowCtx" HomeWindowComponent="this" />
                        }
                    </div>
                }
            </div>

            @* --- Bottom action --- *@
            <div class="bottom-actions">
                <button class="action-btn" @onclick="OnClickAddFriend">
                    <i class="bi bi-person-plus"></i>
                    <span>Manage Friends</span>
                    @if (FriendService.IncomingRequests.Count > 0)
                    {
                        <span class="inline-badge">@FriendService.IncomingRequests.Count</span>
                    }
                </button>
            </div>
        </TabThree>
    </TabContainerComponent>
</div>

@code {
    public static WindowContent<HomeWindowComponent> DefaultContent => new(){
        Icon = "./_content/Valour.Client/media/logo/logo-128.png",
        Title = "Welcome back!"
    };

    [CascadingParameter]
    public ModalRoot ModalRoot { get; set; }

    public event Func<Task> OnRerenderFriendCards;
    public event Func<Task> OnRerenderPlanetCards;

    private string _mobileTag = "";
    private HomeViewMode _viewMode = HomeViewMode.Cards;
    private int? _incomingFriendRequests;
    private string _filterText;

    // Filtered lists
    private IEnumerable<Planet> _filteredPlanets => FilterPlanets();
    private List<DmRenderInfo> _filteredDms => FilterDms();
    private IEnumerable<User> _filteredFriends => FilterFriends();

    // DM state
    private class DmRenderInfo
    {
        public Channel Channel { get; set; }
        public User OtherUser { get; set; }
        public bool IsUnread { get; set; }
        public int Notifications { get; set; }
    }

    private List<DmRenderInfo> _dmRenderList = new();

    protected override async Task OnInitializedAsync()
    {
        PlanetService.JoinedPlanetsUpdated += OnJoinedPlanetsUpdate;
        FriendService.FriendsChanged += OnFriendsListUpdate;

        UpdateFriendBadge();

        // Render planet and friend cards before unread is loaded
        ReRender();

        var unreadPlanetsTask = FetchAndRerenderPlanetsAsync();
        var unreadDirectChannelsTask = FetchAndRerenderDirectChannelsAsync();
        var dmLoadTask = LoadDmsAsync();

        await Task.WhenAll(unreadPlanetsTask, unreadDirectChannelsTask, dmLoadTask);
    }

    private async Task LoadDmsAsync()
    {
        var dmList = new List<DmRenderInfo>();

        foreach (var channel in ChannelService.DirectChatChannels)
        {
            var otherMember = channel.Members?.FirstOrDefault(m => m.UserId != Client.Me.Id);
            if (otherMember is null)
                continue;

            var user = await UserService.FetchUserAsync(otherMember.UserId);
            if (user is null)
                continue;

            dmList.Add(new DmRenderInfo
            {
                Channel = channel,
                OtherUser = user,
                IsUnread = UnreadService.IsChannelUnread(null, channel.Id),
                Notifications = NotificationService.GetChannelNotifications(channel.Id)
            });
        }

        _dmRenderList = dmList.OrderByDescending(d => d.Channel.LastUpdateTime).ToList();
        ReRender();
    }

    private async Task FetchAndRerenderPlanetsAsync()
    {
        await UnreadService.FetchUnreadPlanetsAsync();

        if (OnRerenderPlanetCards is not null)
            await OnRerenderPlanetCards.Invoke();

        ReRender();
    }

    private async Task FetchAndRerenderDirectChannelsAsync()
    {
        await UnreadService.FetchUnreadDirectChannelsAsync();

        if (OnRerenderFriendCards is not null)
            await OnRerenderFriendCards.Invoke();

        // Refresh DM unread state
        foreach (var dm in _dmRenderList)
        {
            dm.IsUnread = UnreadService.IsChannelUnread(null, dm.Channel.Id);
            dm.Notifications = NotificationService.GetChannelNotifications(dm.Channel.Id);
        }

        ReRender();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            if (DeviceInfo.IsMobile)
            {
                _mobileTag = "mobile";
                _viewMode = HomeViewMode.Rows;
                ReRender();
            }
        }

        base.OnAfterRender(firstRender);
    }

    // --- Filtering ---

    private void OnFilterInput(ChangeEventArgs e)
    {
        _filterText = e.Value?.ToString();
        ReRender();
    }

    private IEnumerable<Planet> FilterPlanets()
    {
        if (string.IsNullOrWhiteSpace(_filterText))
            return PlanetService.JoinedPlanets;

        return PlanetService.JoinedPlanets
            .Where(p => p.Name.Contains(_filterText, StringComparison.OrdinalIgnoreCase));
    }

    private List<DmRenderInfo> FilterDms()
    {
        if (string.IsNullOrWhiteSpace(_filterText))
            return _dmRenderList;

        return _dmRenderList
            .Where(d => d.OtherUser.Name.Contains(_filterText, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private IEnumerable<User> FilterFriends()
    {
        if (string.IsNullOrWhiteSpace(_filterText))
            return FriendService.Friends;

        return FriendService.Friends
            .Where(f => f.Name.Contains(_filterText, StringComparison.OrdinalIgnoreCase));
    }

    // --- Actions ---

    private void SetViewMode(HomeViewMode mode)
    {
        _viewMode = mode;
        ReRender();
    }

    private void UpdateFriendBadge()
    {
        var count = FriendService.IncomingRequests.Count;
        _incomingFriendRequests = count > 0 ? count : null;
    }

    private Task OnJoinedPlanetsUpdate()
    {
        ReRender();
        return Task.CompletedTask;
    }

    public void OnClickCreatePlanet()
    {
        var data = new CreatePlanetComponent.ModalParams()
        {
        };

        ModalRoot.OpenModal<CreatePlanetComponent>(data);
    }

    private async Task OnClickDiscover()
    {
        await WindowService.OpenWindowAtFocused(new DiscoveryPageWindowContent());
    }

    private void OnClickAddFriend()
    {
        var data = new EditUserComponent.ModalParams()
        {
            StartCategory = "General Settings",
            StartItem = "Friends",
            User = Client.Me
        };

        ModalRoot.OpenModal<EditUserComponent>(data);
    }

    private void OnFriendsListUpdate(FriendEventData e)
    {
        UpdateFriendBadge();
        ReRender();
    }
}
