@using Valour.Client.Components.Windows.ModTools
@using Valour.Client.Components.Staff
@inherits Modal<EditUserComponent.ModalParams>
@inject NavigationManager NavManager
@inject ValourClient Client


@if (@Data.User is null)
{
    <div class="background">
        <h5>Loading user...</h5>
    </div>
    return;
}

<MainMenuComponent DefaultCategory="@Data.StartCategory" DefaultItem="@Data.StartItem" MenuCategories="@_categories"  />

@code {
    
    [CascadingParameter]
    public BrowserUtils DomWindow { get; set; }
    
    private RenderFragment InfoContent => @<EditUserInfoComponent User="@Data.User" />;
    private RenderFragment ProfileContent => @<EditProfileComponent />;
    private RenderFragment FriendsContent => @<EditFriendsComponent />;
    private RenderFragment ThemesContent => @<EditThemeComponent />;
    private RenderFragment SubscriptionsContent => @<EditSubscriptionsComponent />;
    private RenderFragment ReferralsContent => @<EditReferralsComponent />;
    private RenderFragment NotificationsContent => @<EditUserNotificationsComponent />;
    private RenderFragment DevicePreferencesContent => @<EditDevicePreferencesComponent />;
    private RenderFragment SessionsContent => @<EditSessionsComponent />;
    private RenderFragment LogOutContent => @<div></div>;
    private RenderFragment OAuthContent => @<EditOAuthComponent />;
    private RenderFragment BotsContent => @<BotManagementComponent />;
    private RenderFragment StaffToolsContent =>
        @<TabContainerComponent Titles="@_staffTabs" MaxHeight="100%" ContentStyle="background-color: var(--main-1); padding: 1em">
            <TabOne>
                <StaffUserQueryTable />
            </TabOne>
            <TabTwo>
                <ReportsQueryTable />
            </TabTwo>
            <TabThree>
                <StaffVerifyUserComponent />
            </TabThree>
        </TabContainerComponent>;

    private readonly string[] _staffTabs = new[] { "Members", "Reports", "Verify" };

    private List<MainMenu.MenuCategory> _categories;
    
    private List<MainMenu.MenuCategory> BuildCategories() =>
        new List<MainMenu.MenuCategory>()
        {
            new MainMenu.MenuCategory()
            {
                Name = "General Settings",
                Icon = "gear-fill",
                Items = new List<MainMenu.MenuItem>()
                {
                    new MainMenu.MenuItem()
                    {
                        Name = "Info",
                        Icon = "info-circle-fill",
                        Description = "Edit basic account information",
                        Content = InfoContent
                    },
                    new MainMenu.MenuItem()
                    {
                        Name = "Profile",
                        Icon = "person-fill",
                        Description = "Customize your profile in style",
                        Content = ProfileContent
                    },
                    new MainMenu.MenuItem()
                    {
                        Name = "Friends",
                        Icon = "person-heart",
                        Description = "Manage your friends and requests",
                        Content = FriendsContent
                    },
                    new MainMenu.MenuItem()
                    {
                        Name = "Themes",
                        Icon = "palette-fill",
                        Description = "Create and install custom themes",
                        Content = ThemesContent
                    },
                    new MainMenu.MenuItem()
                    {
                        Name = "Subscriptions",
                        Icon = "rocket-takeoff-fill",
                        Description = "Upgrade your experience!",
                        Content = SubscriptionsContent
                    },
                    new MainMenu.MenuItem()
                    {
                        Name = "Referrals",
                        Icon = "envelope-paper-heart-fill",
                        Description = "Invite friends and earn rewards",
                        Content = ReferralsContent
                    },
                    new MainMenu.MenuItem()
                    {
                        Name = "Notifications",
                        Icon = "bell-fill",
                        Description = "Manage notification preferences and sound",
                        Content = NotificationsContent
                    },
                    new MainMenu.MenuItem()
                    {
                        Name = "Device Preferences",
                        Icon = "phone-fill",
                        Description = "Manage device preferences",
                        Content = DevicePreferencesContent
                    },
                    new MainMenu.MenuItem()
                    {
                        Name = "Sessions",
                        Icon = "shield-lock-fill",
                        Description = "Manage active login sessions",
                        Content = SessionsContent
                    },
                    new MainMenu.MenuItem()
                    {
                        Name = "Log Out",
                        Icon = "x-octagon-fill",
                        Color = "var(--p-red)",
                        Content = LogOutContent,
                        OnClick = LogOut
                    }
                }
            },
            new MainMenu.MenuCategory()
            {
                Name = "Developer",
                Icon = "code-slash",
                Items = new List<MainMenu.MenuItem>()
                {
                    new MainMenu.MenuItem()
                    {
                        Name = "Bots",
                        Icon = "robot",
                        Description = "Create and manage bot accounts",
                        Content = BotsContent
                    },
                    new MainMenu.MenuItem()
                    {
                        Name = "OAuth Apps",
                        Icon = "key-fill",
                        Description = "Manage your OAuth applications and API access",
                        Content = OAuthContent
                    }
                }
            },
        };

    protected override void OnInitialized()
    {
        // Backward compatibility for callers using previous menu item names.
        if (string.Equals(Data.StartItem, "Permissions", StringComparison.OrdinalIgnoreCase)
            || string.Equals(Data.StartItem, "Notification Options", StringComparison.OrdinalIgnoreCase))
        {
            Data.StartItem = "Notifications";
        }

        _categories = BuildCategories();

        // Add staff category if user is staff
        if (Data.User?.ValourStaff == true)
        {
            _categories.Add(new MainMenu.MenuCategory()
            {
                Name = "Staff",
                Icon = "shield-fill",
                Items = new List<MainMenu.MenuItem>()
                {
                    new MainMenu.MenuItem()
                    {
                        Name = "Staff Tools",
                        Icon = "tools",
                        Description = "Manage users and reports",
                        Content = StaffToolsContent
                    }
                }
            });
        }
    }

    public class ModalParams
    {
        public User User;
        public string StartCategory;
        public string StartItem;
    }

    private async Task LogOut()
    {
        try
        {
            var cData = new ConfirmModalComponent.ModalParams(
            "Log Out",
            "Are you sure?",
            "Yes, log out",
            "Cancel",
            async () =>
            {
                var result = await Client.PrimaryNode.PostAsync($"api/users/me/logout", null);
                Console.WriteLine(result.Message);
                NavManager.NavigateTo("/", true);
            },
            () =>
            {
                return Task.CompletedTask;
            }
        );

            ModalRoot.OpenModal<ConfirmModalComponent>(cData);
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);

            // If an error occurs in building/using the ConfirmModal, it reverts back to original behavior and logs out regardless
            var result = await Client.PrimaryNode.PostAsync($"api/users/me/logout", null);
            Console.WriteLine(result.Message);
            NavManager.NavigateTo("/", true);
        }
    }

    private async Task OpenStaffTools()
    {
        var data = new ModToolsWindowData()
        {
            Staff = true
        };

        var content = ModToolsWindowComponent.GetDefaultContent(data);
        var floatingProps = ModToolsWindowComponent.GetDefaultFloatingProps();
        await WindowService.TryAddFloatingWindow(content, floatingProps);

        Close();
    }

}
