@inherits ControlledRenderComponentBase
@inject PlanetService PlanetService
@inject UnreadService UnreadService
@inject NotificationService NotificationService

<div class="joined-planets">
    <div class="list">
        @foreach (var joinedPlanet in _renderPlanets)
        {
            <PlanetRowComponent @key='joinedPlanet.Planet.Id'
                                Planet='joinedPlanet.Planet'
                                IsUnread='joinedPlanet.HasUnread'
                                NotificationCount='joinedPlanet.Notifications'
                                OnClicked='new EventCallback(this, async () => await OnPlanetClick(joinedPlanet.Planet))' />
        }
    </div>
    <div class="bottom-actions">
        <button class="action-btn" @onclick="@OnClickExplore">
            <i class="bi bi-compass"></i>
            <span>Discover Planets</span>
        </button>
    </div>
</div>

@code {

    public class JoinedPlanetRenderInfo
    {
        public Planet Planet { get; set; }
        public bool HasUnread { get; set; }
        public int Notifications { get; set; }
    }

    [Parameter]
    public string FilterText { get; set; }

    private List<JoinedPlanetRenderInfo> _renderPlanets = new();
    private string _lastFilterText;

    protected override async Task OnInitializedAsync()
    {
        PlanetService.JoinedPlanetsUpdated += OnJoinedPlanetsUpdated;

        _ = Task.Run(async () =>
        {
            await Task.WhenAll(
                [
                    UnreadService.FetchUnreadPlanetsAsync(),
                    NotificationService.LoadUnreadNotificationsAsync(),
                ]
            );

            await InvokeAsync(() =>
            {
                OnJoinedPlanetsUpdated();
            });
        });

        OnJoinedPlanetsUpdated();
    }

    protected override void OnParametersSet()
    {
        if (_lastFilterText != FilterText)
        {
            _lastFilterText = FilterText;
            CalculatePlanets();
            ReRender();
        }
    }

    private void OnJoinedPlanetsUpdated()
    {
        _ = InvokeAsync(() =>
        {
            CalculatePlanets();
            ReRender();
        });
    }

    private async Task OnClickExplore()
    {
        var windowContent = new DiscoveryPageWindowContent();
        await WindowService.OpenWindowAtFocused(windowContent);
    }

    private void CalculatePlanets()
    {
        _renderPlanets.Clear();
        var planets = PlanetService.JoinedPlanets;

        if (!string.IsNullOrWhiteSpace(FilterText))
        {
            planets = planets.Where(p => p.Name.Contains(FilterText, StringComparison.OrdinalIgnoreCase)).ToList();
        }

        _renderPlanets = planets.Select(p => new JoinedPlanetRenderInfo
        {
            Planet = p,
            HasUnread = UnreadService.IsPlanetUnread(p.Id),
            Notifications = NotificationService.GetPlanetNotifications(p.Id)
        }).ToList();
    }

    public async Task OnPlanetClick(Planet planet)
    {
        var newWindowContent = await ChatWindowComponent.GetContentForPlanetPrimaryChannel(planet);

        if (newWindowContent is null)
        {
            ToastContainer.Instance.AddToast(new ToastData()
            {
                Title = "Failure loading planet",
                Message = $"Error accessing {planet.Name}",
                Type = ToastProgressState.Failure
            });
        }

        await WindowService.OpenWindowAtFocused(newWindowContent);

        await Sidebar.ToggleMobileSidebar();
    }

}