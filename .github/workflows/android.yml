name: Android APK

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'Valour/Client.Maui/**'
      - 'Valour/Client/**'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.check.outputs.changed }}
      version: ${{ steps.check.outputs.version }}
    steps:
    - uses: actions/checkout@v4

    - name: Check if release already exists
      id: check
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        CURRENT=$(grep -oP '(?<=<ApplicationDisplayVersion>)[^<]+' Valour/Client.Maui/Valour.Client.Maui.csproj)
        echo "version=$CURRENT" >> $GITHUB_OUTPUT

        if gh release view "v$CURRENT" > /dev/null 2>&1; then
          echo "Release v$CURRENT already exists, skipping build"
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "No release for v$CURRENT, will build"
          echo "changed=true" >> $GITHUB_OUTPUT
        fi

  build-android:
    needs: check-version
    if: needs.check-version.outputs.version_changed == 'true'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install MAUI workload
      run: dotnet workload install maui-android

    - name: Materialize Android signing keystore
      id: signing-keystore
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      run: |
        if [ -z "$ANDROID_KEYSTORE_BASE64" ]; then
          echo "Missing required secret: ANDROID_KEYSTORE_BASE64"
          exit 1
        fi

        KEYSTORE_PATH="$RUNNER_TEMP/valour-release.keystore"
        echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > "$KEYSTORE_PATH"
        echo "keystore_path=$KEYSTORE_PATH" >> $GITHUB_OUTPUT

    - name: Validate Android signing secrets
      env:
        ANDROID_SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_SIGNING_STORE_PASSWORD }}
        ANDROID_SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}
        ANDROID_SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }}
      run: |
        if [ -z "$ANDROID_SIGNING_STORE_PASSWORD" ]; then
          echo "Missing required secret: ANDROID_SIGNING_STORE_PASSWORD"
          exit 1
        fi

        if [ -z "$ANDROID_SIGNING_KEY_ALIAS" ]; then
          echo "Missing required secret: ANDROID_SIGNING_KEY_ALIAS"
          exit 1
        fi

        if [ -z "$ANDROID_SIGNING_KEY_PASSWORD" ]; then
          echo "Missing required secret: ANDROID_SIGNING_KEY_PASSWORD"
          exit 1
        fi

    - name: Get short SHA
      id: short-sha
      run: echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

    - name: Replace asset version hashes
      uses: mingjun97/file-regex-replace@v1
      with:
        regex: '\$\(SHORTHASH\)'
        replacement: '${{ steps.short-sha.outputs.short_sha }}'
        flags: "g"
        include: '\.(js|cs|razor|cshtml|html)$'
        exclude: '.^'
        encoding: 'utf8'
        path: '.'

    - name: Restore dependencies
      run: |
        dotnet restore Valour/BuildTools/CssBundler/CssBundler.csproj
        dotnet restore Valour/Client.Maui/Valour.Client.Maui.csproj -p:AndroidSdkDirectory="${{ env.ANDROID_HOME }}"

    - name: Build Client (generates CSS bundle)
      run: dotnet build Valour/Client/Valour.Client.csproj -c Release

    - name: Build APK
      run: >
        dotnet publish Valour/Client.Maui/Valour.Client.Maui.csproj
        -f net10.0-android
        -c Release
        -o ./artifacts
        -p:AndroidKeyStore=true
        -p:AndroidSigningKeyStore="${{ steps.signing-keystore.outputs.keystore_path }}"
        -p:AndroidSigningStorePass="${{ secrets.ANDROID_SIGNING_STORE_PASSWORD }}"
        -p:AndroidSigningKeyAlias="${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}"
        -p:AndroidSigningKeyPass="${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }}"
        -p:AndroidPackageFormat=apk
        -p:AndroidSdkDirectory="${{ env.ANDROID_HOME }}"

    - name: Find APK
      id: find-apk
      run: |
        APK_PATH=$(find ./artifacts -name '*.apk' | head -1)
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        echo "Found APK: $APK_PATH"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.check-version.outputs.version }}
        name: Valour v${{ needs.check-version.outputs.version }}
        files: ${{ steps.find-apk.outputs.apk_path }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
