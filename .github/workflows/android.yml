name: Android APK

on:
  push:
    branches: [ main ]
    paths:
      - 'Valour/Client.Maui/Valour.Client.Maui.csproj'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.check.outputs.changed }}
      version: ${{ steps.check.outputs.version }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Check if version changed
      id: check
      run: |
        # Extract current version
        CURRENT=$(grep -oP '(?<=<ApplicationDisplayVersion>)[^<]+' Valour/Client.Maui/Valour.Client.Maui.csproj)
        # Extract previous version
        PREVIOUS=$(git show HEAD~1:Valour/Client.Maui/Valour.Client.Maui.csproj 2>/dev/null | grep -oP '(?<=<ApplicationDisplayVersion>)[^<]+' || echo "")

        echo "Previous: $PREVIOUS"
        echo "Current:  $CURRENT"
        echo "version=$CURRENT" >> $GITHUB_OUTPUT

        if [ "$CURRENT" != "$PREVIOUS" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

  build-android:
    needs: check-version
    if: needs.check-version.outputs.version_changed == 'true'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      run: |
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
        cd $ANDROID_SDK_ROOT/cmdline-tools
        curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o tools.zip
        unzip -q tools.zip
        mv cmdline-tools latest
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platforms;android-35" "build-tools;35.0.0" "platform-tools"
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV

    - name: Install MAUI workload
      run: dotnet workload install maui-android

    - name: Get short SHA
      id: short-sha
      run: echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

    - name: Replace asset version hashes
      uses: mingjun97/file-regex-replace@v1
      with:
        regex: '\$\(SHORTHASH\)'
        replacement: '${{ steps.short-sha.outputs.short_sha }}'
        flags: "g"
        include: '.*'
        exclude: '.^'
        encoding: 'utf8'
        path: '.'

    - name: Restore dependencies
      run: dotnet restore Valour/Client.Maui/Valour.Client.Maui.csproj -p:AndroidSdkDirectory="${{ env.ANDROID_HOME }}"

    - name: Build APK
      run: >
        dotnet publish Valour/Client.Maui/Valour.Client.Maui.csproj
        -f net10.0-android
        -c Release
        -o ./artifacts
        -p:AndroidSdkDirectory="${{ env.ANDROID_HOME }}"

    - name: Find APK
      id: find-apk
      run: |
        APK_PATH=$(find ./artifacts -name '*.apk' | head -1)
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        echo "Found APK: $APK_PATH"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.check-version.outputs.version }}
        name: Valour v${{ needs.check-version.outputs.version }}
        files: ${{ steps.find-apk.outputs.apk_path }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
